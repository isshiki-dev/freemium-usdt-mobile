name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  EXPO_TOKEN: _oM7Zmye2kWPm_4YB2MFj2iR8d2vOtQyn6aL3kDn

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Create assets if missing
        run: |
          mkdir -p assets
          if [ ! -f assets/splash.png ]; then
            python3 << 'EOF'
          from PIL import Image, ImageDraw
          splash = Image.new('RGBA', (1284, 2778), (3, 7, 18, 255))
          draw = ImageDraw.Draw(splash)
          cx, cy = 642, 1389
          draw.ellipse([cx-80, cy-80, cx+80, cy+80], fill=(16, 185, 129, 255))
          splash.save('assets/splash.png')
          icon = Image.new('RGBA', (1024, 1024), (3, 7, 18, 255))
          draw = ImageDraw.Draw(icon)
          cx, cy = 512, 512
          draw.ellipse([cx-300, cy-300, cx+300, cy+300], fill=(16, 185, 129, 255))
          draw.rectangle([cx-60, cy-150, cx+60, cy+150], fill=(255, 255, 255, 255))
          draw.rectangle([cx-120, cy-80, cx+120, cy-40], fill=(255, 255, 255, 255))
          draw.rectangle([cx-120, cy+40, cx+120, cy+80], fill=(255, 255, 255, 255))
          icon.save('assets/icon.png')
          icon.save('assets/adaptive-icon.png')
          icon.save('assets/favicon.png')
          icon.resize((200, 200)).save('assets/splash-icon.png')
          print("Assets created!")
          EOF
          fi

      - name: Generate Keystore
        run: |
          mkdir -p android/app
          keytool -genkeypair -v \
            -keystore android/app/release.keystore \
            -alias freemiumusdt \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass freemium2025 \
            -keypass freemium2025 \
            -dname "CN=Freemium USDT, OU=Development, O=FreemiumUSDT, L=Dhaka, ST=Dhaka, C=BD"

      - name: Create credentials.json
        run: |
          cat > credentials.json << 'EOF'
          {
            "android": {
              "keystore": {
                "keystorePath": "android/app/release.keystore",
                "keystorePassword": "freemium2025",
                "keyAlias": "freemiumusdt",
                "keyPassword": "freemium2025"
              }
            }
          }
          EOF

      - name: Update eas.json for local credentials
        run: |
          cat > eas.json << 'EOF'
          {
            "cli": {
              "version": ">= 12.0.0",
              "appVersionSource": "remote"
            },
            "build": {
              "preview": {
                "distribution": "internal",
                "android": {
                  "buildType": "apk",
                  "credentialsSource": "local"
                }
              },
              "production": {
                "android": {
                  "buildType": "app-bundle",
                  "credentialsSource": "local"
                }
              }
            }
          }
          EOF

      - name: Build APK with EAS
        run: eas build --platform android --profile preview --local --non-interactive --output ./app-release.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: freemium-usdt-apk
          path: ./app-release.apk
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ./app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
