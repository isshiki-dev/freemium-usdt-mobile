name: Build Android APK & AAB

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  EXPO_TOKEN: _oM7Zmye2kWPm_4YB2MFj2iR8d2vOtQyn6aL3kDn

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm install

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Install Pillow for asset generation
        run: pip install Pillow

      - name: Create assets
        run: |
          mkdir -p assets
          python3 << 'EOF'
          from PIL import Image, ImageDraw
          splash = Image.new('RGBA', (1284, 2778), (3, 7, 18, 255))
          draw = ImageDraw.Draw(splash)
          cx, cy = 642, 1389
          draw.ellipse([cx-80, cy-80, cx+80, cy+80], fill=(16, 185, 129, 255))
          splash.save('assets/splash.png')
          icon = Image.new('RGBA', (1024, 1024), (3, 7, 18, 255))
          draw = ImageDraw.Draw(icon)
          cx, cy = 512, 512
          draw.ellipse([cx-300, cy-300, cx+300, cy+300], fill=(16, 185, 129, 255))
          draw.rectangle([cx-60, cy-150, cx+60, cy+150], fill=(255, 255, 255, 255))
          draw.rectangle([cx-120, cy-80, cx+120, cy-40], fill=(255, 255, 255, 255))
          draw.rectangle([cx-120, cy+40, cx+120, cy+80], fill=(255, 255, 255, 255))
          icon.save('assets/icon.png')
          icon.save('assets/adaptive-icon.png')
          icon.save('assets/favicon.png')
          icon.resize((200, 200)).save('assets/splash-icon.png')
          print("Assets created!")
          EOF

      - name: Generate Keystore
        run: |
          mkdir -p android/app
          keytool -genkeypair -v \
            -keystore android/app/release.keystore \
            -alias freemiumusdt \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass freemium2025 \
            -keypass freemium2025 \
            -dname "CN=Freemium USDT, OU=Development, O=FreemiumUSDT, L=Dhaka, ST=Dhaka, C=BD"

      - name: Create credentials.json
        run: |
          cat > credentials.json << 'EOF'
          {
            "android": {
              "keystore": {
                "keystorePath": "android/app/release.keystore",
                "keystorePassword": "freemium2025",
                "keyAlias": "freemiumusdt",
                "keyPassword": "freemium2025"
              }
            }
          }
          EOF

      - name: Update eas.json for local credentials
        run: |
          cat > eas.json << 'EOF'
          {
            "cli": {
              "version": ">= 12.0.0",
              "appVersionSource": "remote"
            },
            "build": {
              "preview": {
                "distribution": "internal",
                "android": {
                  "buildType": "apk",
                  "credentialsSource": "local"
                }
              },
              "production": {
                "android": {
                  "buildType": "app-bundle",
                  "credentialsSource": "local"
                }
              }
            }
          }
          EOF

      - name: Build APK
        run: eas build --platform android --profile preview --local --non-interactive --output ./freemium-usdt-v1.0.0.apk

      - name: Build AAB (Play Store Bundle)
        run: eas build --platform android --profile production --local --non-interactive --output ./freemium-usdt-v1.0.0.aab

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: freemium-usdt-apk
          path: ./freemium-usdt-v1.0.0.apk
          retention-days: 90

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: freemium-usdt-aab
          path: ./freemium-usdt-v1.0.0.aab
          retention-days: 90

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create Auto Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-build.${{ steps.date.outputs.date }}
          name: "Freemium & Flash USDT v1.0.0 (Build ${{ steps.date.outputs.date }})"
          body: |
            ## ðŸš€ Freemium & Flash USDT Mobile App
            
            ### Downloads
            - **APK** - Direct install on Android devices
            - **AAB** - For Google Play Store upload
            
            ### Features
            - Age verification gate (18+)
            - Key-based authentication (Free/Pro/Enterprise tiers)
            - Dashboard with tier-specific features
            - API integration with likhonsheikh.xyz
            - Dark theme with emerald accent
            
            ### Build Info
            - Build Date: ${{ steps.date.outputs.date }}
            - Expo SDK: 52
            - React Native: 0.76.3
            
            ---
            ðŸ¤– Auto-generated by GitHub Actions
          files: |
            ./freemium-usdt-v1.0.0.apk
            ./freemium-usdt-v1.0.0.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
